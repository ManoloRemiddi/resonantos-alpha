{% extends "base.html" %}
{% block title %}Bounties — ResonantOS DAO{% endblock %}
{% block page_title %}Bounty Board{% endblock %}

{% block content %}
<style>
.bounty-toolbar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:1.25rem;
    flex-wrap:wrap;
    gap:0.65rem;
}
.bounty-toolbar select {
    background:var(--card-bg,#1e1e2e);
    border:1px solid var(--border,#333);
    color:var(--text-primary,#e0e0e0);
    padding:0.45rem;
    border-radius:6px;
    font-size:0.83rem;
}
.btn-primary {
    background:#6C5CE7;
    color:#fff;
    border:none;
    border-radius:6px;
    padding:0.5rem 1rem;
    font-size:0.85rem;
    font-weight:600;
    cursor:pointer;
}
.btn-primary:hover { background:#5b4bd5; }
.wallet-pill {
    font-size:0.8rem;
    color:var(--text-secondary,#999);
    padding:0.4rem 0.8rem;
    background:var(--card-bg,#1e1e2e);
    border:1px solid var(--border,#333);
    border-radius:20px;
}
.bounty-grid {
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
    gap:1rem;
}
.bounty-card {
    background:var(--card-bg,#1e1e2e);
    border:1px solid var(--border,#333);
    border-radius:10px;
    padding:1rem;
    display:flex;
    flex-direction:column;
    gap:0.55rem;
}
.bounty-card:target {
    border-color:#6C5CE7;
    box-shadow:0 0 0 1px rgba(108,92,231,0.45);
}
.bounty-header {
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:0.5rem;
}
.bounty-title {
    margin:0;
    font-size:0.95rem;
    color:var(--text-primary,#e0e0e0);
}
.priority {
    font-size:0.74rem;
    font-weight:700;
    padding:0.15rem 0.45rem;
    border-radius:4px;
    background:rgba(108,92,231,0.2);
    color:#a78bfa;
    white-space:nowrap;
}
.badges { display:flex; gap:0.35rem; flex-wrap:wrap; }
.badge {
    font-size:0.72rem;
    padding:0.15rem 0.5rem;
    border-radius:4px;
    color:var(--text-secondary,#999);
    background:rgba(255,255,255,0.06);
}
.badge.cat-community { background:rgba(16,185,129,0.15); color:#34d399; }
.badge.cat-research { background:rgba(59,130,246,0.15); color:#60a5fa; }
.badge.cat-economy { background:rgba(245,158,11,0.15); color:#fbbf24; }
.badge.cat-core { background:rgba(168,85,247,0.15); color:#c084fc; }
.badge.cat-technical { background:rgba(239,68,68,0.15); color:#f87171; }
.badge.cat-creative { background:rgba(236,72,153,0.15); color:#f472b6; }
.badge.status-open { background:rgba(16,185,129,0.15); color:#34d399; }
.badge.status-claimed { background:rgba(59,130,246,0.15); color:#60a5fa; }
.badge.status-in_progress { background:rgba(245,158,11,0.15); color:#fbbf24; }
.badge.status-review { background:rgba(168,85,247,0.15); color:#c084fc; }
.badge.status-verified { background:rgba(20,241,149,0.15); color:#14F195; }
.badge.status-rewarded { background:rgba(20,241,149,0.2); color:#14F195; font-weight:600; }
.tribe-badge {
    display:inline-flex;
    align-items:center;
    gap:0.35rem;
    font-size:0.72rem;
    color:#a78bfa;
    border:1px solid rgba(167,139,250,0.4);
    border-radius:20px;
    padding:0.15rem 0.5rem;
    text-decoration:none;
    background:rgba(108,92,231,0.12);
}
.tribe-badge:hover { border-color:#a78bfa; }
.reward {
    font-size:0.84rem;
    color:var(--text-primary,#e0e0e0);
    font-weight:600;
}
.team {
    display:flex;
    justify-content:space-between;
    font-size:0.8rem;
    color:var(--text-secondary,#999);
}
.card-actions {
    display:flex;
    gap:0.5rem;
    margin-top:auto;
}
.card-actions button {
    flex:1;
    background:var(--card-bg,#1e1e2e);
    border:1px solid var(--border,#333);
    color:var(--text-primary,#e0e0e0);
    padding:0.42rem;
    border-radius:6px;
    cursor:pointer;
    font-size:0.8rem;
}
.card-actions button:hover {
    border-color:#6C5CE7;
    color:#6C5CE7;
}
.panel {
    background:var(--card-bg,#1e1e2e);
    border:1px solid var(--border,#333);
    border-radius:8px;
    padding:1rem;
}
.modal {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.72);
    z-index:1000;
    align-items:center;
    justify-content:center;
}
.modal.active { display:flex; }
.modal-content {
    background:var(--bg,#121218);
    border:1px solid var(--border,#333);
    border-radius:12px;
    width:90%;
    max-width:820px;
    max-height:85vh;
    overflow-y:auto;
    padding:1.2rem;
}
.modal-head {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:0.8rem;
}
.close-btn {
    background:none;
    border:none;
    color:var(--text-secondary,#999);
    font-size:1.2rem;
    cursor:pointer;
}
.detail-grid {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:0.9rem;
    margin-top:0.9rem;
}
.list {
    margin:0;
    padding-left:1.1rem;
    color:var(--text-secondary,#999);
    font-size:0.8rem;
}
.list li { margin-bottom:0.35rem; }
.muted { color:var(--text-secondary,#999); font-size:0.8rem; }
.actions { display:flex; flex-direction:column; gap:0.4rem; margin-top:0.8rem; }
.actions button {
    background:var(--card-bg,#1e1e2e);
    border:1px solid var(--border,#333);
    color:var(--text-primary,#e0e0e0);
    padding:0.4rem 0.8rem;
    border-radius:6px;
    cursor:pointer;
    font-size:0.8rem;
}
.actions button:hover { border-color:#6C5CE7; color:#6C5CE7; }
.review-block input,
.review-block select,
.review-block textarea {
    width:100%;
    background:var(--card-bg,#1e1e2e);
    border:1px solid var(--border,#333);
    color:var(--text-primary,#e0e0e0);
    padding:0.4rem;
    border-radius:4px;
    font-size:0.8rem;
    margin-top:0.3rem;
}
.review-block textarea { min-height:60px; resize:vertical; }
@media (max-width: 700px) {
    .detail-grid { grid-template-columns:1fr; }
}
</style>

<div class="bounty-toolbar">
    <select id="statusFilter" onchange="reloadBounties()">
        <option value="">All Status</option>
        <option value="open">Open</option>
        <option value="claimed">Claimed</option>
        <option value="in_progress">In Progress</option>
        <option value="review">Review</option>
        <option value="verified">Verified</option>
        <option value="rewarded">Rewarded</option>
    </select>
    <select id="categoryFilter" onchange="reloadBounties()">
        <option value="">All Category</option>
        <option value="community">Community</option>
        <option value="research">Research</option>
        <option value="economy">Economy</option>
        <option value="core">Core</option>
        <option value="technical">Technical</option>
        <option value="creative">Creative</option>
    </select>
    <select id="priorityFilter" onchange="reloadBounties()">
        <option value="">All Priority</option>
        <option value="P0">P0</option>
        <option value="P1">P1</option>
        <option value="P2">P2</option>
    </select>
    <select id="sizeFilter" onchange="reloadBounties()">
        <option value="">All Size</option>
        <option value="small">Small</option>
        <option value="medium">Medium</option>
        <option value="large">Large</option>
    </select>
    <select id="tribeFilter" onchange="reloadBounties()">
        <option value="">All Tribes</option>
    </select>
    <select id="sortBy" onchange="reloadBounties()">
        <option value="priority">Sort: Priority</option>
        <option value="reward">Sort: Reward</option>
        <option value="date">Sort: Date</option>
    </select>
    <button class="btn-primary" onclick="connectWallet()">Connect Phantom</button>
    <div class="wallet-pill" id="walletDisplay">Wallet: not connected</div>
</div>

<div class="bounty-grid" id="bountyGrid"></div>

<div class="modal" id="detailModal">
    <div class="modal-content">
        <div class="modal-head">
            <h3 id="detailTitle" style="margin:0;"></h3>
            <button class="close-btn" onclick="closeDetail()">&#10005;</button>
        </div>
        <div class="badges" id="detailBadges"></div>

        <div class="detail-grid">
            <div class="panel">
                <h4 style="margin:0 0 0.5rem;">Description</h4>
                <p id="detailDescription" class="muted"></p>

                <h4 style="margin:0.9rem 0 0.5rem;">Acceptance Criteria</h4>
                <ul id="detailCriteria" class="list"></ul>

                <h4 style="margin:0.9rem 0 0.5rem;">Required Skills</h4>
                <div id="detailSkills" class="muted"></div>

                <h4 style="margin:0.9rem 0 0.5rem;">Reviews</h4>
                <div id="detailReviews" class="muted"></div>
            </div>

            <div class="panel">
                <h4 style="margin:0 0 0.5rem;">Tribe</h4>
                <div id="detailTeam" class="muted"></div>
                <h4 style="margin:0.9rem 0 0.5rem;">Quality Gate</h4>
                <div id="detailQuality" class="muted"></div>

                <div class="actions">
                    <button onclick="claimSelected()">Claim Bounty</button>
                    <button onclick="joinSelected()">Join Tribe</button>
                    <button onclick="leaveSelected()">Leave Tribe</button>
                    <button onclick="submitSelected()">Submit for Review</button>
                    <button onclick="rewardSelected()">Trigger Reward</button>
                </div>

                <div class="review-block" style="margin-top:0.8rem;">
                    <h4 style="margin:0;">Review</h4>
                    <input id="reviewScore" type="number" min="1" max="5" placeholder="Score 1-5">
                    <select id="reviewMethod">
                        <option value="verified">verified</option>
                        <option value="peer-reviewed">peer-reviewed</option>
                        <option value="unverifiable">unverifiable</option>
                    </select>
                    <textarea id="reviewComments" placeholder="Review comments"></textarea>
                    <div style="display:flex; gap:0.5rem;">
                        <button onclick="reviewSelected(true)">Approve</button>
                        <button onclick="reviewSelected(false)">Reject</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let bounties = [];
let tribes = [];
let selected = null;
let connectedWallet = null;

const categoryClass = (c) => `cat-${c || 'core'}`;
const statusClass = (s) => `status-${s || 'draft'}`;

function esc(value) {
    const d = document.createElement('div');
    d.textContent = value == null ? '' : String(value);
    return d.innerHTML;
}

function shortWallet(wallet) {
    return wallet ? `${wallet.slice(0, 6)}...${wallet.slice(-4)}` : 'n/a';
}

function buildQuery() {
    const params = new URLSearchParams();
    ['status', 'category', 'priority', 'size'].forEach((key) => {
        const value = document.getElementById(`${key}Filter`).value;
        if (value) params.set(key, value);
    });
    const tribeId = document.getElementById('tribeFilter').value;
    if (tribeId) params.set('tribeId', tribeId);
    const sort = document.getElementById('sortBy').value;
    if (sort) params.set('sort', sort);
    return params.toString();
}

async function loadTribesForFilter() {
    const res = await fetch('/api/tribes');
    const data = await res.json();
    tribes = data.tribes || [];

    const filter = document.getElementById('tribeFilter');
    const current = filter.value;
    const options = ['<option value="">All Tribes</option>'];
    tribes.forEach((tribe) => {
        options.push(`<option value="${esc(tribe.id)}">${esc(tribe.name)}</option>`);
    });
    filter.innerHTML = options.join('');
    filter.value = current;
}

function tribeBadge(tribe) {
    if (!tribe || !tribe.id) {
        return '<span class="badge">Unassigned</span>';
    }
    return `<a class="tribe-badge" href="/tribes#${esc(tribe.id)}" title="Open tribe">◉ ${esc(tribe.name || tribe.id)}</a>`;
}

async function reloadBounties() {
    const query = buildQuery();
    const res = await fetch(`/api/bounties${query ? `?${query}` : ''}`);
    const data = await res.json();
    bounties = data.bounties || [];

    const grid = document.getElementById('bountyGrid');
    if (!bounties.length) {
        grid.innerHTML = '<div class="panel">No bounties found.</div>';
        return;
    }

    grid.innerHTML = bounties.map((bounty) => {
        const members = ((bounty.tribe && bounty.tribe.members) || []);
        return `
            <article class="bounty-card" id="${esc(bounty.id)}">
                <div class="bounty-header">
                    <h4 class="bounty-title">${esc(bounty.title)}</h4>
                    <div class="priority">${esc(bounty.priority)}</div>
                </div>
                <div class="badges">
                    <span class="badge ${categoryClass(bounty.category)}">${esc(bounty.category)}</span>
                    <span class="badge ${statusClass(bounty.status)}">${esc(bounty.status)}</span>
                    <span class="badge">${esc(bounty.size)}</span>
                </div>
                <div>${tribeBadge(bounty.tribe)}</div>
                <div class="reward">${Number(bounty.rewardRCT || 0)} $RCT + ${Number(bounty.rewardRES || 0)} $RES</div>
                <div class="team"><span>Team</span><span>${members.length}/${Number(bounty.teamMaxSize || 6)}</span></div>
                <div class="card-actions">
                    <button onclick="openDetail('${bounty.id}')">Details</button>
                    <button onclick="quickClaim('${bounty.id}')">Claim</button>
                </div>
            </article>
        `;
    }).join('');

    const hashId = window.location.hash.replace('#', '').trim();
    if (hashId) {
        const exists = bounties.find((b) => b.id === hashId);
        if (exists) {
            await openDetail(hashId, false);
            const node = document.getElementById(hashId);
            if (node) node.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
    }
}

async function connectWallet() {
    if (!window.solana || !window.solana.isPhantom) {
        alert('Phantom wallet not found.');
        return;
    }
    const resp = await window.solana.connect();
    connectedWallet = resp.publicKey.toString();
    document.getElementById('walletDisplay').textContent = `Wallet: ${shortWallet(connectedWallet)}`;
}

async function quickClaim(id) {
    if (!connectedWallet) {
        alert('Connect wallet first.');
        return;
    }

    const res = await fetch(`/api/bounties/${id}/claim`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({wallet: connectedWallet})
    });
    const data = await res.json();
    if (!res.ok) {
        alert(data.error || 'Claim failed.');
    }
    await reloadBounties();
}

async function openDetail(id, updateHash = true) {
    const res = await fetch(`/api/bounties/${id}`);
    selected = await res.json();
    if (selected.error) {
        alert(selected.error || 'Unable to load bounty detail.');
        return;
    }

    if (updateHash) {
        window.location.hash = selected.id;
    }

    document.getElementById('detailTitle').textContent = selected.title;
    document.getElementById('detailDescription').textContent = selected.description || '';

    document.getElementById('detailBadges').innerHTML = `
        <span class="badge ${categoryClass(selected.category)}">${esc(selected.category)}</span>
        <span class="badge ${statusClass(selected.status)}">${esc(selected.status)}</span>
        <span class="badge">${esc(selected.priority)}</span>
        <span class="badge">${esc(selected.size)}</span>
    `;

    document.getElementById('detailCriteria').innerHTML = (selected.acceptanceCriteria || [])
        .map((criterion) => `<li>${esc(criterion)}</li>`)
        .join('');

    document.getElementById('detailSkills').textContent = (selected.requiredSkills || []).join(', ') || 'None';

    const tribe = selected.tribe || {};
    const members = tribe.members || [];
    const tribeLink = tribe.id
        ? `<a class="tribe-badge" href="/tribes#${esc(tribe.id)}">◉ ${esc(tribe.name || tribe.id)}</a>`
        : '<span class="badge">Unassigned</span>';

    document.getElementById('detailTeam').innerHTML = `
        <div style="margin-bottom:0.4rem;">${tribeLink}</div>
        ${members.length
            ? members.map((member) => `• ${esc(shortWallet(member.wallet || member))}${member.role ? ` (${esc(member.role)})` : ''}`).join('<br>')
            : 'No members yet'}
    `;

    const quality = selected.qualityGate || {};
    document.getElementById('detailQuality').innerHTML = `
        Status: ${esc(quality.status || 'pending')}<br>
        Score: ${quality.score == null ? '-' : quality.score}<br>
        Method: ${esc(quality.verificationMethod || '-')}
    `;

    const reviews = selected.reviews || [];
    document.getElementById('detailReviews').innerHTML = reviews.length
        ? reviews.map((review) => `• ${esc(shortWallet(review.reviewerWallet))}: ${review.approved ? 'approved' : 'rejected'} (${review.score}/5) — ${esc(review.comments || '')}`).join('<br>')
        : 'No reviews yet';

    document.getElementById('detailModal').classList.add('active');
}

function closeDetail() {
    document.getElementById('detailModal').classList.remove('active');
    selected = null;
}

async function action(path, body = {}) {
    if (!selected) return;
    if (!connectedWallet) {
        alert('Connect wallet first.');
        return;
    }

    const res = await fetch(path, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({wallet: connectedWallet, ...body})
    });
    const data = await res.json();
    if (!res.ok) {
        alert(data.error || 'Request failed.');
        return;
    }

    await reloadBounties();
    await openDetail(selected.id, false);
}

function claimSelected() { action(`/api/bounties/${selected.id}/claim`); }
function joinSelected() { action(`/api/bounties/${selected.id}/join`); }
function leaveSelected() { action(`/api/bounties/${selected.id}/leave`); }
function submitSelected() { action(`/api/bounties/${selected.id}/submit`); }
function rewardSelected() { action(`/api/bounties/${selected.id}/reward`); }

function reviewSelected(approve) {
    const score = Number(document.getElementById('reviewScore').value || 0);
    const comments = document.getElementById('reviewComments').value || '';
    const verificationMethod = document.getElementById('reviewMethod').value;
    action(`/api/bounties/${selected.id}/review`, {approve, score, comments, verificationMethod});
}

document.addEventListener('DOMContentLoaded', async () => {
    await loadTribesForFilter();
    await reloadBounties();
});
</script>
{% endblock %}
